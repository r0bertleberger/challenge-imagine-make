from utils import *
import numpy as np
from matplotlib.pyplot import *
import pandas as pd
from scipy.signal import find_peaks, butter, filtfilt


def detect_fibrillation_auriculaire(n: int):
    """
    Détecte la fibrillation auriculaire (FA) à partir des données ECG.

    Parameters:
        n (int): Index du fichier ECG à analyser.
        ecg_df (pd.DataFrame): DataFrame contenant les signaux ECG.

    Returns:
        dict: Résultat de l'analyse avec détection de la FA.
    """
    results = {
        "irregular_rr": False,
        "absent_p_wave": False,
        "frequency_spread": False,
        "is_fa": False
    }

    ecg_df = pd.read_csv(df_meta.iloc[n].ecg_file_path)

    # Filtrage du signal ECG (passe-bas pour réduire le bruit)
    fs = 360  # Fréquence d'échantillonnage en Hz (exemple, à ajuster selon les données)
    cutoff_low = 0.5  # Basse fréquence pour onde P (à ajuster selon les données)
    cutoff_high = 10  # Haute fréquence pour onde P (à ajuster selon les données)
    b, a = butter(2, [cutoff_low / (fs / 2), cutoff_high / (fs / 2)], btype='band')
    signal_II = ecg_df[" II"]
    filtered_signal = filtfilt(b, a, signal_II)

    # Analyse des intervalles RR (irregular_rr)
    diff_signal = np.diff(filtered_signal)  # Différences successives
    peaks, _ = find_peaks(diff_signal, height=0)  # Trouver les pics (ici, tout simplement les dérivées positives)
    rr_intervals = np.diff(peaks)  # Intervalles RR en échantillons

    if len(rr_intervals) > 1:
        std_rr = np.std(rr_intervals)
        mean_rr = np.mean(rr_intervals)
        irregularity_threshold = 0.2 * mean_rr  # Seuil d'irrégularité (20%)
        results["irregular_rr"] = std_rr > irregularity_threshold

    # Vérification de la séquence onde P suivie d'une onde QRS
    qrs_peaks, _ = find_peaks(filtered_signal, height=0)  # Trouver les pics QRS
    p_qrs_intervals = np.diff(peaks)  # Intervalles entre les pics P et QRS

    if len(p_qrs_intervals) > 0 and all(p_qrs_intervals > 0):
        results["absent_p_wave"] = False  # Chaque onde P est suivie d'une onde QRS
    else:
        results["absent_p_wave"] = True  # Absence de suivi correct

    # Analyse fréquentielle (frequency_spread)
    fft_freqs_full, fft_amplitudes_full = np.fft.fftfreq(len(filtered_signal), 1 / fs), np.fft.fft(filtered_signal)
    spread_energy = sum(fft_amplitudes_full[(fft_freqs_full > 5) & (fft_freqs_full < 10)])
    total_energy_full = sum(fft_amplitudes_full)
    results["frequency_spread"] = (spread_energy / total_energy_full) > 0.1  # Si énergie notable entre 5-10 Hz

    # Conclusion sur la FA
    results["is_fa"] = all([results["irregular_rr"], results["absent_p_wave"], results["frequency_spread"]])

    return results

L = [0, 26, 53, 73, 74, 101, 115, 116, 145, 146, 181, 189, 199, 204, 210, 233, 297, 313, 374, 388, 434, 443, 451, 463, 471, 485, 497, 521, 528, 532, 537, 570, 571, 585, 589, 591, 620, 664, 682, 698, 733, 759, 814, 843, 847, 848, 857, 877, 882, 888, 911, 914, 916, 940, 947, 948, 986, 1001, 1015, 1016, 1019, 1020, 1034, 1039, 1055, 1069, 1070, 1116, 1136, 1177, 1193, 1194, 1197, 1214, 1234, 1245, 1246, 1283, 1310, 1316, 1318, 1319, 1345, 1353, 1370, 1397, 1402, 1404, 1405, 1421, 1489, 1490, 1492, 1503, 1512, 1513, 1515, 1516, 1517, 1565, 1574, 1575, 1577, 1583, 1613, 1637, 1652, 1705, 1709, 1731, 1748, 1839, 1875, 1876, 1886, 1902, 2001, 2015, 2016, 2019, 2020, 2033, 2042, 2055, 2104, 2132, 2144, 2187, 2228, 2241, 2256, 2259, 2270, 2281, 2286, 2293, 2303, 2360, 2362, 2366, 2368, 2373, 2389, 2435, 2442, 2447, 2483, 2487, 2509, 2517, 2523, 2524, 2551, 2574, 2593, 2610, 2633, 2648, 2657, 2672, 2676, 2683, 2752, 2775, 2793, 2809, 2815, 2868, 2908, 2928, 2938, 2960, 2997, 3001, 3003, 3015, 3051, 3063, 3082, 3083, 3105, 3106, 3114, 3138, 3152, 3176, 3183, 3280, 3286, 3287, 3296, 3302, 3377, 3380, 3381, 3383, 3386, 3437, 3438, 3439, 3468, 3469, 3510, 3511, 3515, 3525, 3535, 3559, 3569, 3573, 3590, 3612, 3773, 3792, 3809, 3830, 3833, 3845, 3850, 3879, 3908, 3953, 3971, 3976, 4022, 4080, 4090, 4124, 4140, 4153, 4161, 4170, 4187, 4281, 4292, 4313, 4320, 4365, 4409, 4413, 4429, 4430, 4447, 4463, 4480, 4559, 4574, 4575, 4660, 4689, 4694, 4695, 4709, 4717, 4723, 4726, 4769, 4783, 4795, 4816, 4818, 4835, 4836, 4837, 4842, 4846, 4851, 4856, 4867, 4885, 4886, 4896, 4911, 4912, 4997, 5026, 5031, 5032, 5046, 5054, 5060, 5063, 5106, 5120, 5131, 5153, 5155, 5172, 5173, 5174, 5179, 5183, 5188, 5193, 5204, 5222, 5223, 5234, 5235, 5239, 5240, 5241, 5242, 5243, 5250, 5271, 5279, 5281, 5294, 5302, 5322, 5329, 5339, 5353, 5361, 5362, 5365, 5366, 5384, 5412, 5426, 5435, 5437, 5449, 5466, 5472, 5475, 5477, 5483, 5487, 5492, 5516, 5520, 5530, 5533, 5534, 5536, 5547, 5548, 5549, 5602, 5625, 5626, 5633, 5637, 5715, 5717, 5753, 5760, 5784, 5787, 5788, 5836, 5854, 5872, 5893, 5907, 5940, 5948, 5952, 5960, 5971, 5973, 5975, 5982, 5985, 6044, 6072, 6073, 6088, 6091, 6092, 6123, 6208, 6267, 6269, 6274, 6281, 6301, 6319, 6354, 6378, 6379, 6398, 6402, 6424, 6435, 6436, 6437, 6438, 6439, 6440, 6449, 6457, 6492, 6524, 6534, 6542, 6546, 6549, 6550, 6568, 6612, 6626, 6629, 6630, 6650, 6660, 6673, 6674, 6675, 6677, 6678, 6679, 6710, 6735, 6736, 6749, 6753, 6757, 6758, 6759, 6774, 6777, 6788, 6789, 6791, 6804, 6805, 6823, 6853, 6877, 6879, 6905, 6909, 6941, 6980, 6985, 7022, 7040, 7058, 7061, 7062, 7068, 7069, 7070, 7071, 7076, 7077, 7082, 7085, 7108, 7109, 7110, 7114, 7117, 7126, 7134, 7146, 7181, 7185, 7190, 7192, 7223, 7233, 7249, 7269, 7271, 7314, 7350, 7352, 7376, 7408, 7412, 7423, 7491, 7496, 7537, 7586, 7601, 7608, 7629, 7654, 7666, 7683, 7768, 7786, 7819, 7853, 7873, 7882, 7902, 7903, 7924, 7940, 7946, 7954, 7955, 7959, 7968, 7978, 8031, 8076, 8090, 8131, 8172, 8229, 8247, 8276, 8287, 8293, 8348, 8398, 8468, 8486, 8488, 8502, 8596, 8599, 8600, 8612, 8650, 8653, 8662, 8742, 8747, 8748, 8772, 8783, 8833, 8834, 8848, 8875, 8901, 8908, 8926, 8930, 8962, 8969, 8977, 8984, 8988, 8999, 9009, 9079, 9095, 9120, 9133, 9139, 9169, 9218, 9232, 9234, 9243, 9284, 9298, 9300, 9310, 9356, 9374, 9402, 9406, 9417, 9430, 9435, 9438, 9461, 9467, 9531, 9554, 9578, 9639, 9656, 9676, 9693, 9695, 9707, 9739, 9755, 9833, 9848, 9849, 9868, 9875, 9903, 9908, 9912, 9943, 9954, 9990, 10002, 10084, 10085, 10096, 10097, 10120, 10152, 10153, 10170, 10171, 10193, 10198, 10251, 10297, 10325, 10331, 10372, 10450, 10453, 10461, 10462, 10463, 10494, 10511, 10527, 10531, 10532, 10570, 10577, 10578, 10591, 10597, 10615, 10625, 10650, 10652, 10653, 10669, 10696, 10724, 10740, 10782, 10784, 10856, 10857, 10875, 10893, 10894, 10924, 10928, 10936, 10938, 10957, 10992, 10993, 10994, 10995, 10996, 10998, 11012, 11020, 11036, 11039, 11145, 11155, 11201, 11217, 11258, 11309, 11315, 11384, 11398, 11437, 11443, 11459, 11472, 11475, 11480, 11498, 11501, 11503, 11517, 11539, 11578, 11611, 11614, 11632, 11648, 11710, 11795, 11796, 11858, 11859, 11872, 11887, 11922, 11947, 11949, 11956, 11960, 11961, 11967, 11968, 11977, 11985, 11991, 12015, 12022, 12033, 12034, 12039, 12040, 12044, 12064, 12066, 12085, 12086, 12096, 12108, 12109, 12121, 12132, 12136, 12152, 12156, 12159, 12166, 12176, 12186, 12196, 12225, 12226, 12256, 12263, 12268, 12275, 12277, 12340, 12351, 12405, 12416, 12427, 12443, 12497, 12532, 12587, 12624, 12715, 12749, 12781, 12803, 12814, 12882, 12899, 12937, 12965, 13094, 13140, 13150, 13153, 13155, 13158, 13169, 13173, 13177, 13197, 13207, 13211, 13213, 13245, 13250, 13265, 13307, 13311, 13331, 13332, 13420, 13430, 13516, 13523, 13529, 13565, 13579, 13599, 13600, 13640, 13648, 13667, 13668, 13672, 13696, 13697, 13701, 13704, 13709, 13732, 13754, 13755, 13778, 13787, 13880, 13881, 13882, 13883, 13885, 13901, 13975, 14111, 14157, 14197, 14221, 14243, 14244, 14245, 14279, 14314, 14320, 14352, 14376, 14392, 14399, 14466, 14467, 14468, 14488, 14499, 14502, 14514, 14517, 14522, 14591, 14651, 14720, 14721, 14741, 14789, 14790, 14794, 14797, 14845, 14846, 14871, 14872, 14881, 14882, 14892, 14919, 14931, 14949, 14954, 14960, 14962, 14967, 14968, 14969, 14970, 15017, 15032, 15037, 15044, 15045, 15077, 15108, 15113, 15130, 15144, 15148, 15200, 15212, 15220, 15221, 15225, 15226, 15234, 15235, 15239, 15244, 15266, 15302, 15316, 15330, 15333, 15344, 15356, 15385, 15397, 15405, 15416, 15422, 15456, 15457, 15460, 15465, 15482, 15497, 15525, 15526, 15527, 15528, 15529, 15540, 15545, 15574, 15587, 15621, 15645, 15655, 15737, 15758, 15759, 15776, 15777, 15791, 15826, 15838, 15844, 15854, 15857, 15859, 15864, 15871, 15875, 15895, 15898, 15912, 15922, 15923, 15925, 15926, 15955, 15956, 15967, 15974, 15980, 15982, 15986, 15987, 15995, 16000, 16001, 16014, 16015, 16093, 16094, 16103, 16126, 16130, 16136, 16139, 16179, 16200, 16208, 16261, 16281, 16291, 16317, 16331, 16362, 16384, 16388, 16429, 16435, 16492, 16523, 16530, 16545, 16559, 16585, 16634, 16658, 16736, 16748, 16749, 16773, 16815, 16851, 16855, 16856, 16880, 16890, 16895, 16903, 16919, 17002, 17032, 17074, 17075, 17087, 17111, 17117, 17121, 17146, 17186, 17188, 17252, 17294, 17304, 17305, 17322, 17323, 17332, 17333, 17392, 17408, 17420, 17462, 17470, 17482, 17496, 17533, 17535, 17537, 17538, 17551, 17566, 17573, 17585, 17586, 17593, 17636, 17640, 17671, 17672, 17710, 17737, 17784, 17785, 17788, 17867, 17868, 17881, 17885, 17887, 17926, 17943, 17950, 17965, 17975, 17983, 17996, 18034, 18052, 18064, 18083, 18089, 18124, 18143, 18172, 18187, 18207, 18236, 18238, 18296, 18297, 18316, 18317, 18342, 18356, 18369, 18371, 18431, 18437, 18438, 18460, 18482, 18495, 18591, 18596, 18597, 18607, 18621, 18628, 18656, 18663, 18743, 18769, 18798, 18799, 18800, 18820, 18861, 18895, 18995, 19011, 19018, 19027, 19149, 19166, 19246, 19258, 19273, 19281, 19356, 19375, 19378, 19404, 19406, 19412, 19417, 19422, 19423, 19424, 19427, 19428, 19429, 19431, 19448, 19449, 19462, 19467, 19468, 19490, 19502, 19503, 19504, 19557, 19560, 19561, 19579, 19580, 19637, 19638, 19674, 19689, 19701, 19737, 19738, 19747, 19779, 19795, 19805, 19851, 19854, 19861, 19872, 19894, 19895, 19907, 19909, 19951, 19960, 20066, 20073, 20124, 20154, 20199, 20200, 20216, 20231, 20273, 20284, 20305, 20316, 20349, 20395, 20411, 20413, 20453, 20489, 20533, 20536, 20613, 20678, 20690, 20696, 20701, 20722, 20731, 20738, 20751, 20752, 20762, 20773, 20790, 20795, 20908, 20910, 20917, 20925, 20932, 20944, 20950, 20954, 20955, 20956, 20966, 21004, 21041, 21057, 21069, 21091, 21092, 21099, 21107, 21167, 21229, 21249, 21257, 21281, 21291, 21313, 21314, 21316, 21319, 21324, 21325, 21326, 21360, 21366, 21381, 21388, 21391, 21394, 21397, 21405, 21414, 21429, 21438, 21442, 21444, 21452, 21453, 21459, 21545, 21582, 21583, 21584, 21585, 21586, 21587, 21588, 21613, 21619, 21623, 21628, 21637, 21649, 21656, 21712, 21728, 21731, 21766, 21768, 21770, 21819, 21825, 21861, 21887, 21895, 21998, 21999, 22007, 22027, 22054, 22123, 22167, 22184, 22185, 22245, 22257, 22287, 22297, 22302, 22303, 22304, 22355, 22359, 22367, 22370, 22371, 22375, 22376, 22398, 22429, 22462, 22501, 22526, 22534, 22551, 22557, 22562, 22570, 22599, 22615, 22623, 22651, 22669, 22687, 22693, 22694, 22723, 22748, 22756, 22767, 22768, 22772, 22773, 22788, 22795, 22822, 22823, 22824, 22830, 22854, 22857, 22862, 22863, 22873, 22891, 22904, 22916, 22936, 22949, 22956, 22987, 22992, 22995, 23021, 23051, 23057, 23060, 23061, 23071, 23072, 23075, 23122, 23134, 23136, 23137, 23141, 23142, 23177, 23183, 23202, 23228, 23229, 23251, 23252, 23263, 23283, 23291, 23294, 23305, 23320, 23368, 23370, 23429, 23449, 23450, 23451, 23461, 23462, 23467, 23468, 23476, 23494, 23495, 23545, 23557, 23563, 23570, 23573, 23578, 23596, 23631, 23632, 23672, 23674, 23677, 23686, 23714, 23764, 23766, 23767, 23796, 23800, 23818, 23821, 23827, 23830, 23837, 23839, 23852, 23875, 23929, 23945, 23962, 23985, 23993, 24004, 24018, 24019, 24038, 24088, 24101, 24108, 24117, 24133, 24135, 24155, 24163, 24170, 24172, 24224, 24229, 24230, 24233, 24237, 24248, 24251, 24263, 24264, 24266, 24267, 24286, 24299, 24345, 24348, 24357, 24375, 24378, 24387, 24409, 24446, 24452, 24472, 24479, 24516, 24524, 24529, 24555, 24578, 24598, 24614, 24643, 24657, 24663, 24664, 24665, 24674, 24682, 24686, 24693, 24720, 24734, 24735, 24751, 24759, 24763, 24796, 24874, 24885, 24890, 24891, 24902, 24963, 24969, 24991, 25024, 25057, 25058, 25059, 25086, 25160, 25161, 25192, 25233, 25237, 25244, 25246, 25254, 25290, 25292, 25352, 25404, 25411, 25412, 25415, 25423, 25435, 25450, 25475, 25508, 25523, 25539, 25558, 25559, 25597, 25614, 25625, 25626, 25692, 25699, 25708, 25716, 25718, 25732, 25751, 25752, 25777, 25787, 25796, 25804, 25827, 25866, 25883, 25885, 25886, 25906, 25932, 25937, 25946, 25953, 25960, 25976, 25993, 25994, 26017, 26106, 26115, 26117, 26124, 26132, 26136, 26137, 26147, 26162, 26176, 26250, 26294, 26301, 26308, 26322, 26341, 26343, 26369, 26380, 26393, 26394, 26395, 26396, 26398, 26404, 26426, 26427, 26428, 26485, 26495, 26514, 26515, 26529, 26567, 26577, 26602, 26607, 26639, 26715, 26752, 26790, 26810, 26824, 26832, 26841, 26854, 26878, 26909, 26921, 26933, 26947, 26954, 26955, 26960, 26965, 26995, 26996, 27009, 27021, 27082, 27126, 27138, 27139, 27145, 27149, 27158, 27174, 27207, 27212, 27253, 27254, 27297, 27319, 27348, 27363, 27432, 27468, 27474, 27477, 27478, 27556, 27564, 27565, 27566, 27597, 27616, 27634, 27647, 27652, 27657, 27662, 27663, 27675, 27689, 27701, 27725, 27752, 27753, 27755, 27774, 27776, 27786, 27787, 27800, 27801, 27828, 27849, 27895, 27914, 27930, 27933, 27950, 27960, 27966, 27978, 27979, 27982, 27986, 28038, 28052, 28081, 28089, 28090, 28106, 28114, 28118, 28173, 28203, 28207, 28326, 28359, 28368, 28460, 28463, 28485, 28516, 28530, 28532, 28582, 28595, 28600, 28602, 28628, 28671, 28672, 28677, 28767, 28773, 28817, 28855, 28862, 28869, 28970, 28998, 29002, 29013, 29050, 29121, 29127, 29146, 29165, 29166, 29176, 29183, 29185, 29223, 29229, 29239, 29253, 29254, 29300, 29312, 29321, 29347, 29428, 29429, 29430, 29439, 29443, 29445, 29446, 29447, 29448, 29449, 29454, 29542, 29550, 29581, 29592, 29603, 29611, 29613, 29615, 29635, 29645, 29672, 29673, 29681, 29786, 29787, 29788, 29790, 29820, 29821, 29845, 29853, 29857, 29868, 29869, 29925, 29933, 30003, 30009, 30055, 30091, 30100, 30103, 30133, 30136, 30202, 30203, 30247, 30254, 30257, 30258, 30293, 30299, 30319, 30329, 30340, 30348, 30396, 30435, 30444, 30451, 30461, 30474, 30514, 30552, 30554, 30580, 30604, 30625, 30642, 30643, 30645, 30658, 30663, 30664, 30743, 30753, 30765, 30781, 30782, 30815, 30818, 30830, 30843, 30860, 30868, 30870, 30872, 30874, 30877, 30932, 30986, 31019, 31083, 31084, 31098, 31099, 31122, 31173, 31209, 31236, 31266, 31284, 31297, 31310, 31314, 31320, 31327, 31328, 31337, 31377, 31398, 31455, 31467, 31477, 31492, 31495, 31532, 31568, 31578, 31626, 31627, 31628, 31629, 31687, 31693, 31711, 31721, 31732, 31754, 31777, 31778, 31779, 31780, 31816, 31819, 31820, 31835, 31867, 31868, 31869, 31870, 31872, 31874, 31882, 31891, 31892, 31949, 32000, 32001, 32020, 32025, 32028, 32083, 32084, 32085, 32092, 32093, 32105, 32109, 32146, 32168, 32175, 32216, 32217, 32258, 32278, 32321, 32323, 32336, 32339, 32345, 32359, 32365, 32411, 32417, 32435, 32436, 32492, 32507, 32508, 32509, 32519, 32524]

for i in L:
    print(df_meta.iloc[i].diagnosis)
    print(detect_fibrillation_auriculaire(i))